<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Predictor League 2026</title>
    <style>
        /* --- CSS STYLES (The Look) --- */
        :root { --f1-red: #e10600; --bg: #15151e; --card-bg: #1f1f23; --text: #ffffff; }
        body { margin: 0; font-family: 'Titillium Web', sans-serif; background-color: var(--bg); color: var(--text); }
        
        /* Layout */
        header { background: var(--f1-red); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; font-style: italic; }
        nav button { background: none; border: none; color: white; font-weight: bold; cursor: pointer; padding: 10px; font-size: 1rem; }
        nav button:hover { text-decoration: underline; }
        
        main { padding: 20px; max-width: 800px; margin: 0 auto; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Forms */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        
        input { width: 100%; padding: 12px; margin: 8px 0; background: #2a2a2f; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        input:focus { border-color: var(--f1-red); outline: none; }
        label { font-size: 0.9rem; color: #ccc; font-weight: bold; }

        /* Buttons */
        .btn-submit { background: var(--f1-red); color: white; border: none; padding: 15px; width: 100%; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 20px; }
        .btn-submit:hover { background: #b30000; }

        /* Cards & Tables */
        .prediction-card { background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--f1-red); border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #2a2a2f; color: var(--f1-red); }

        /* Admin Panel (Hidden by default) */
        .admin-box { margin-top: 40px; border: 2px solid var(--f1-red); padding: 20px; background: rgba(225, 6, 0, 0.1); border-radius: 8px; text-align: center; }
        .admin-btn { background: var(--f1-red); color: white; padding: 12px 24px; border: none; cursor: pointer; font-weight: bold; font-size: 1rem; border-radius: 4px; }
        
        /* Login Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; }
        .auth-btn { margin: 10px 5px; padding: 10px 20px; cursor: pointer; background: #444; color: white; border: none; border-radius: 4px; }
        .auth-btn.primary { background: var(--f1-red); }
    </style>
</head>
<body>

    <header>
        <h1>üèéÔ∏è F1 PREDICTOR '26</h1>
        <nav>
            <button onclick="switchTab('predict')">Predict</button>
            <button onclick="switchTab('live')">Live Race</button>
            <button onclick="switchTab('standings')">Standings</button>
            <button onclick="logout()">Logout</button>
        </nav>
    </header>

    <main>
        <div id="predict" class="tab-content active">
            <h2>Race Strategy: <span id="race-name" style="color:var(--f1-red)">Loading...</span></h2>
            <form id="prediction-form">
                <div class="form-grid">
                    <div>
                        <h3>Drivers</h3>
                        <label>Podium</label>
                        <input type="text" id="p1" placeholder="P1 Winner" required>
                        <input type="text" id="p2" placeholder="P2 Runner Up" required>
                        <input type="text" id="p3" placeholder="P3 Third" required>
                        
                        <label>Mid-Field Battle</label>
                        <input type="text" id="p11" placeholder="P11 (Just missed points)" required>
                        <input type="text" id="p12" placeholder="P12" required>
                        
                        <label>Backmarkers</label>
                        <input type="text" id="p19" placeholder="P19" required>
                        <input type="text" id="p20" placeholder="P20 Last Place" required>
                    </div>
                    <div>
                        <h3>Constructors</h3>
                        <label>Team Ranks (Combined Points)</label>
                        <input type="text" id="c1" placeholder="1st Place Team" required>
                        <input type="text" id="c2" placeholder="2nd Place Team" required>
                        <input type="text" id="c5" placeholder="5th Place Team" required>
                        <input type="text" id="c6" placeholder="6th Place Team" required>
                        <input type="text" id="c10" placeholder="10th Place Team" required>
                        
                        <h3>Wildcard</h3>
                        <label>Biggest Loser (Positions Dropped)</label>
                        <input type="text" id="wl" placeholder="Driver Name" required>
                    </div>
                </div>
                <button type="submit" class="btn-submit">üîí Lock In Strategy</button>
            </form>
        </div>

        <div id="live" class="tab-content">
            <h2>Live Paddock Status</h2>
            <p style="color:#888;">Strategies locked in for this weekend:</p>
            <div id="live-list"></div>

            <div id="admin-controls" style="display: none;" class="admin-box">
                <h3>‚ö†Ô∏è STEWARDS CONTROL</h3>
                <p>Calculates scores based on official results and resets the grid.</p>
                <button id="finalize-btn" class="admin-btn">Finalize Race Weekend</button>
                <p id="admin-status" style="margin-top:10px; font-weight:bold;"></p>
            </div>
        </div>

        <div id="standings" class="tab-content">
            <h2>World Championship Standings</h2>
            <table>
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Driver</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
    </main>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h2>Paddock Entry</h2>
            <p>Identify yourself to enter the garage.</p>
            <input type="text" id="auth-name" placeholder="Driver Name">
            <input type="password" id="auth-pass" placeholder="Password (Secret Key)">
            <div style="margin-top: 20px;">
                <button class="auth-btn primary" onclick="login()">Login</button>
                <button class="auth-btn" onclick="register()">Register</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP & AUTH ---
        let currentUser = JSON.parse(localStorage.getItem('f1_user'));

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentUser) {
                document.getElementById('login-modal').style.display = 'flex';
            } else {
                document.getElementById('login-modal').style.display = 'none';
                initApp();
            }
        });

        function initApp() {
            fetchNextRace();
            checkAdmin(); // Checks if you are 'admin'
            loadLeaderboard();
        }

        async function login() {
            const name = document.getElementById('auth-name').value;
            const password = document.getElementById('auth-pass').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, password })
            });
            const data = await res.json();
            if (data.success) {
                localStorage.setItem('f1_user', JSON.stringify({ name, password }));
                location.reload();
            } else {
                alert("Access Denied: " + data.message);
            }
        }

        async function register() {
            const name = document.getElementById('auth-name').value;
            const password = document.getElementById('auth-pass').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, password })
            });
            const data = await res.json();
            alert(data.message);
        }

        function logout() {
            localStorage.removeItem('f1_user');
            location.reload();
        }

        // --- 2. ADMIN SECURITY ---
        function checkAdmin() {
            const adminPanel = document.getElementById('admin-controls');
            // STRICT CHECK: Only shows if username is 'admin'
            if (currentUser && currentUser.name === 'admin') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
        }

        document.getElementById('finalize-btn').addEventListener('click', async () => {
            if (!confirm("‚ö†Ô∏è CONFIRM: Finalize Race? This will calculate scores and wipe predictions!")) return;
            
            const status = document.getElementById('admin-status');
            status.innerText = "Processing...";
            
            try {
                const res = await fetch('/api/finalize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        user_name: currentUser.name, 
                        password: currentUser.password 
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    status.innerText = "‚úÖ Success! Grid Reset.";
                    status.style.color = "#00ff00";
                    setTimeout(() => location.reload(), 2000);
                } else {
                    status.innerText = "‚ùå Error: " + data.message;
                    status.style.color = "red";
                }
            } catch (e) {
                status.innerText = "‚ùå Connection Failed";
            }
        });

        // --- 3. GAMEPLAY LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'live') loadLivePredictions();
            if (tabId === 'standings') loadLeaderboard();
        }

        async function fetchNextRace() {
            try {
                const res = await fetch('/api/next-race');
                const data = await res.json();
                document.getElementById('race-name').innerText = data.name;
            } catch (e) { console.error(e); }
        }

        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                user_name: currentUser.name,
                password: currentUser.password,
                p1: document.getElementById('p1').value,
                p2: document.getElementById('p2').value,
                p3: document.getElementById('p3').value,
                // UPDATED P11/P12
                p11: document.getElementById('p11').value,
                p12: document.getElementById('p12').value,
                p19: document.getElementById('p19').value,
                p20: document.getElementById('p20').value,
                c1: document.getElementById('c1').value,
                c2: document.getElementById('c2').value,
                c5: document.getElementById('c5').value,
                c6: document.getElementById('c6').value,
                c10: document.getElementById('c10').value,
                w_race_loser: document.getElementById('wl').value
            };

            const res = await fetch('/predict', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (res.ok) alert("Strategy Locked! Good luck.");
            else alert("Error submitting.");
        });

        async function loadLivePredictions() {
            const res = await fetch('/api/predictions');
            const data = await res.json();
            const list = document.getElementById('live-list');
            if (data.length === 0) list.innerHTML = "<p>No predictions yet.</p>";
            else {
                list.innerHTML = data.map(p => `
                    <div class="prediction-card">
                        <h3>${p.user_name}</h3>
                        <div>P1: <b>${p.p1}</b></div>
                        <div>C1: <b>${p.c1}</b></div>
                    </div>
                `).join('');
            }
        }

        async function loadLeaderboard() {
            const res = await fetch('/api/season-leaderboard');
            const data = await res.json();
            document.getElementById('leaderboard-body').innerHTML = data.map((d, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td>${d.name}</td>
                    <td><b>${d.total_score}</b></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>