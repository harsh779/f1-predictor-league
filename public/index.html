<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>F1 2026 Strategy League</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="F1 Strategy">
    <link rel="apple-touch-icon" href="/icon.svg">

    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        // Version bumped to 1.8 to force your devices to update the rules text
        (function() {
            const currentVersion = "1.8"; 
            const storedVersion = localStorage.getItem('app_version');
            if (storedVersion !== currentVersion) {
                localStorage.setItem('app_version', currentVersion);
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        for(let registration of registrations) { registration.unregister(); }
                    });
                }
                window.location.href = window.location.pathname + "?v=" + new Date().getTime();
            }
        })();
    </script>

    <style>
        :root { 
            --red: #e10600; 
            --red-glow: rgba(225, 6, 0, 0.15);
            --bg-light: #f5f5f7; 
            --surface: #ffffff; 
            --surface-hover: #eaeaea;
            --surface-inner: #f8f8fc; 
            --text-main: #15151e; 
            --text-muted: #666677; 
            --border: #d1d1d6; 
            --gold: #c59b27;
            --nav-bg: #eef0f2;
        }

        body { margin: 0; font-family: 'Titillium Web', sans-serif; background: var(--bg-light); color: var(--text-main); overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-light); }
        ::-webkit-scrollbar-thumb { background: #b0b0b0; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--red); }

        header { 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); 
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            flex-wrap: wrap; gap: 15px;
        }
        h1 { margin: 0; font-size: 1.6rem; font-weight: 900; font-style: italic; letter-spacing: 1px; color: var(--text-main); white-space: nowrap; order: 1; flex-shrink: 0;}
        h1 span { color: var(--red); }
        
        .user-dropdown { position: relative; display: inline-block; cursor: pointer; font-family: 'Titillium Web'; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); order: 2; flex-shrink: 0; margin-left: auto;}
        .user-dropdown-content { display: none; position: absolute; right: 0; top: 130%; background-color: var(--surface); min-width: 150px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-radius: 8px; z-index: 1000; border: 1px solid var(--border); overflow: hidden; }
        .user-dropdown.show .user-dropdown-content { display: block; animation: slideUp 0.2s ease; }
        .user-dropdown-content button { width: 100%; text-align: left; padding: 15px 20px; background: none; border: none; font-family: 'Titillium Web'; font-size: 1rem; font-weight: 700; color: var(--red); cursor: pointer; transition: background 0.2s; border-radius: 0; }
        .user-dropdown-content button:hover { background-color: var(--surface-hover); }

        nav { display: flex; gap: 8px; align-items: center; order: 3; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px; }
        nav::-webkit-scrollbar { display: none; }
        nav button { 
            background: var(--nav-bg); color: var(--text-muted); border: 2px solid transparent; 
            font-family: 'Titillium Web', sans-serif; font-weight: 700; cursor: pointer; padding: 10px 18px; 
            border-radius: 30px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s ease; 
            white-space: nowrap; flex-shrink: 0;
        }
        nav button:hover { color: var(--text-main); background: #e0e2e6; }
        nav button.active-nav { background: var(--surface); color: var(--red); border: 2px solid var(--red); box-shadow: 0 4px 10px var(--red-glow); }
        
        .btn-support { background: rgba(197, 155, 39, 0.1) !important; color: var(--gold) !important; border: 1px solid var(--gold) !important; }
        .btn-support:hover { background: var(--gold) !important; color: #fff !important; box-shadow: 0 0 15px rgba(197,155,39,0.4); }

        @media (min-width: 900px) {
            header { padding: 15px 30px; gap: 20px; flex-wrap: nowrap; }
            h1 { font-size: 1.8rem; }
            nav { order: 2; width: auto; flex: 1; padding-bottom: 0; justify-content: flex-start; margin-left: 20px; }
            .user-dropdown { order: 3; margin-left: 0; }
            nav button { font-size: 0.95rem; padding: 10px 20px; }
        }

        main { padding: 30px 20px; max-width: 1200px; margin: 0 auto; min-height: 80vh; }
        .tab { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); } 
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .predict-group { background: var(--surface); border: 1px solid var(--border); padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        .predict-group h3 { margin: 0 0 20px 0; border-bottom: 2px solid var(--border); padding-bottom: 10px; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); }
        label { font-size: 0.85rem; color: var(--text-muted); font-weight: 700; display: block; text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; letter-spacing: 1px;}
        
        input.selector-input { 
            width: 100%; padding: 14px 45px 14px 16px; background-color: var(--surface); border: 2px solid var(--border); 
            color: var(--text-main); border-radius: 8px; font-family: 'Titillium Web', sans-serif; font-size: 1.05rem; 
            font-weight: 700; box-sizing: border-box; transition: all 0.2s ease; cursor: pointer; outline: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23d1d1d6" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>'); 
            background-repeat: no-repeat; background-position: right 16px center; 
        }
        input.selector-input:focus, input.selector-input:active { border-color: var(--red); box-shadow: 0 0 0 4px var(--red-glow); background-color: #fffafA;}
        input.selector-input[value]:not([value=""]) { border-color: var(--text-main); background-image: url('data:image/svg+xml;utf8,<svg fill="%2300e160" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>');}
        
        .btn { background: linear-gradient(45deg, #e10600, #c20000); color: white; border: none; padding: 18px; width: 100%; font-family: 'Titillium Web', sans-serif; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; border-radius: 8px; font-size: 1.2rem; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(225, 6, 0, 0.25); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(225, 6, 0, 0.4); }
        
        .live-grid-container { display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr) minmax(0,1fr); gap: 20px; font-size: 0.95rem; }
        .live-card-section { background: var(--surface-inner); padding: 18px; border-radius: 8px; border: 1px solid var(--border); box-sizing: border-box;}
        .live-card-title { color: var(--text-muted); display: block; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 12px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }

        .section-title { border-bottom: 2px solid var(--border); padding-bottom: 10px; color: var(--text-main); font-weight: 900; text-transform: uppercase; letter-spacing: 1px; font-size: 2rem; margin-top: 0;}
        .table-wrapper { overflow-x: auto; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);}
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--surface-inner); color: var(--text-muted); padding: 16px; text-align: left; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; font-weight: 700; border-bottom: 2px solid var(--border);}
        td { padding: 18px 16px; border-bottom: 1px solid var(--border); font-size: 1.05rem; }
        tbody tr:hover { background: var(--surface-hover); }

        .vip-gold { background: linear-gradient(45deg, #c59b27, #e2c044); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900 !important; }
        .vip-badge { background: rgba(197, 155, 39, 0.1); border: 1px solid var(--gold); color: var(--gold); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; vertical-align: middle; margin-left: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;}

        .skeleton { background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; height: 20px; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--text-main); border-left: 5px solid var(--red); color: white; padding: 16px 24px; border-radius: 8px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.15); font-family: 'Titillium Web'; font-size: 1rem; letter-spacing: 0.5px; animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); min-width: 250px; }
        .toast.success { border-left-color: #00e160; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }

        .grid-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter: blur(5px); display:flex; justify-content:center; align-items:flex-end; z-index:9999; }
        .grid-modal-content { background: var(--bg-light); width: 100%; max-width: 700px; max-height: 85vh; border-radius: 20px 20px 0 0; padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @media (min-width: 768px) { .grid-modal { align-items: center; } .grid-modal-content { border-radius: 20px; max-height: 80vh; } }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .grid-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; }
        .grid-modal-header h3 { margin: 0; font-size: 1.3rem; text-transform: uppercase; color: var(--text-main); font-weight: 900;}
        .close-btn { background: none; border: none; font-size: 2rem; color: var(--text-muted); cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .close-btn:hover { color: var(--red); }
        
        .modal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; overflow-y: auto; padding-bottom: 30px; }
        .modal-grid-btn { background: var(--surface); border: 1px solid var(--border); padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-family: 'Titillium Web'; font-size: 1.1rem; font-weight: 700; color: var(--text-main); cursor: pointer; transition: all 0.2s ease; border-left: 5px solid var(--team-color); }
        .modal-grid-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--text-main); }
        .modal-grid-btn.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); transform: none; box-shadow: none; border-color: var(--border); }
        .modal-grid-btn .num { background: var(--team-color); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; font-weight: 900; font-size: 0.9rem; }

        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(5px); display:flex; justify-content:center; align-items:center; z-index:999; }
        .modal-box { background:var(--surface); padding:40px; border-radius:12px; width:90%; max-width:400px; text-align:center; border:1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.2);}
        .hidden { display:none !important; }
        .sprint-badge { background: var(--red); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; font-weight: 900; letter-spacing: 1px; vertical-align: middle; }

        @media (max-width: 850px) {
            header { padding: 15px 15px 0 15px !important; flex-direction: row !important; flex-wrap: wrap !important; }
            h1 { font-size: 1.4rem !important; margin: 0 !important; width: auto !important; flex: 1; }
            .user-dropdown { margin: 0 !important; }
            
            nav { 
                width: 100vw !important; margin-left: -15px !important; margin-top: 15px !important; 
                padding: 10px 15px 15px 15px !important; border-top: 1px solid var(--border) !important; 
                overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; 
                display: flex !important; flex-wrap: nowrap !important; justify-content: flex-start !important; gap: 8px !important;
            }
            nav button { flex: 0 0 auto !important; font-size: 0.85rem !important; padding: 10px 15px !important; }
            main { padding: 15px 12px !important; }
            
            .live-grid-container { display: flex !important; flex-direction: column !important; gap: 15px !important; }
            #dash-container { flex-direction: column !important; padding: 15px !important; }
            .form-grid { display: flex !important; flex-direction: column !important; gap: 15px !important; }
            .predict-group { padding: 15px !important; margin-bottom: 15px !important; }
            #grid-container { grid-template-columns: 1fr !important; }
            
            input.selector-input { padding: 12px 35px 12px 12px !important; font-size: 1rem !important; }
            #r-header { font-size: 1.5rem !important; }
            th, td { padding: 10px 8px !important; font-size: 0.9rem !important; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="grid-selector-modal" class="grid-modal hidden">
    <div class="grid-modal-content">
        <div class="grid-modal-header">
            <h3 id="selector-title">Select...</h3>
            <button class="close-btn" onclick="closeSelectorModal()">&times;</button>
        </div>
        <div id="selector-grid" class="modal-grid"></div>
    </div>
</div>

<header>
    <h1><span>F1</span> 2026 LEAGUE</h1>
    
    <div id="user-menu" class="user-dropdown hidden" onclick="toggleUserMenu()">
        üë§ <span id="logged-in-name" style="margin-left: 5px; color: var(--red);"></span>
        <div id="user-dropdown-content" class="user-dropdown-content">
            <button onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <nav id="main-nav">
        <button onclick="tab('predict', this)" class="active-nav">Predict</button>
        <button onclick="tab('live', this)">Live</button>
        <button onclick="tab('standings', this)">Standings</button>
        <button onclick="tab('calendar', this)">üìÖ Calendar</button>
        <button onclick="tab('grid', this)">üèéÔ∏è The Grid</button>
        <button onclick="tab('rules', this)">üìú Rules</button>
        <button onclick="tab('archive', this)">üèÜ Archive</button>
        <button onclick="showSupportModal()" class="btn-support">‚òï Support</button>
        <button id="install-btn" class="hidden" onclick="installApp()" style="color: #00e160; border: 1px solid #00e160; background: rgba(0, 225, 96, 0.1);">üì≤ Install App</button>
    </nav>
</header>

<main>
    <div id="predict" class="tab active">
        <div id="dash-container" style="background: linear-gradient(135deg, var(--surface) 0%, var(--bg-light) 100%); padding: 30px; border-radius: 12px; border: 1px solid var(--border); border-left: 6px solid var(--red); margin-bottom: 30px; box-shadow: 0 6px 20px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 25px; justify-content: space-between;">
            
            <div style="flex: 1; min-width: 250px;">
                <p id="r-round" style="color: var(--red); font-weight: 900; font-size: 1rem; text-transform: uppercase; margin: 0 0 5px 0; letter-spacing: 2px;">Loading Telemetry...</p>
                <h2 id="r-header" style="margin: 0 0 10px 0; font-size: 2.2rem; font-weight: 900; text-transform: uppercase;"><div class="skeleton" style="width: 60%; height: 40px;"></div></h2>
                <p id="r-record" style="margin: 0; color: var(--text-muted); font-size: 1rem;"><div class="skeleton" style="width: 40%; margin-top: 10px;"></div></p>
            </div>

            <div style="background: var(--surface-inner); border: 1px solid var(--border); border-radius: 8px; padding: 20px; min-width: 220px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);">
                <h4 style="margin:0 0 12px 0; color:var(--text-main); text-transform:uppercase; font-size:0.85rem; letter-spacing:1px; border-bottom:1px solid var(--border); padding-bottom:6px;">Live Track Conditions</h4>
                <div id="weather-widget">
                    <div class="skeleton" style="width: 80%; height: 25px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 60%; height: 15px;"></div>
                </div>
            </div>
        </div>

        <div id="locked-msg" class="hidden" style="background:rgba(225,6,0,0.05); border: 2px solid var(--red); padding:20px; text-align:center; font-weight: 900; border-radius: 8px; margin-bottom: 25px; letter-spacing: 1px; color: var(--red);">üö´ PARC FERM√â: PREDICTIONS LOCKED</div>
        
        <form id="p-form">
            <div class="form-grid">
                <div>
                    <div class="predict-group">
                        <h3>üèÜ The Podium</h3>
                        <label>P1 Winner</label><input type="text" id="p1" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p1', 'driver', 'Select P1 Winner')" required>
                        <label>P2 Runner Up</label><input type="text" id="p2" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p2', 'driver', 'Select P2 Runner Up')" required>
                        <label>P3 Third</label><input type="text" id="p3" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p3', 'driver', 'Select P3 Third')" required>
                    </div>

                    <div class="predict-group">
                        <h3>üéØ The Points Bubble</h3>
                        <label>P11 (Heartbreak)</label><input type="text" id="p11" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p11', 'driver', 'Select P11 (Just Missed Points)')" required>
                        <label>P12</label><input type="text" id="p12" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p12', 'driver', 'Select P12')" required>
                    </div>

                    <div class="predict-group">
                        <h3>‚ö†Ô∏è The Backmarkers</h3>
                        <label>P19</label><input type="text" id="p19" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p19', 'driver', 'Select P19')" required>
                        <label>P20 Last Place</label><input type="text" id="p20" class="s-driver selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('p20', 'driver', 'Select P20 Last Place')" required>
                    </div>
                </div>

                <div>
                    <div class="predict-group">
                        <h3>üè≠ Constructor Targets</h3>
                        <label>1st Team</label><input type="text" id="c1" class="s-team selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('c1', 'team', 'Select 1st Team')" required>
                        <label>2nd Team</label><input type="text" id="c2" class="s-team selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('c2', 'team', 'Select 2nd Team')" required>
                        <label>5th Team</label><input type="text" id="c5" class="s-team selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('c5', 'team', 'Select 5th Team')" required>
                        <label>6th Team</label><input type="text" id="c6" class="s-team selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('c6', 'team', 'Select 6th Team')" required>
                        <label>10th Team</label><input type="text" id="c10" class="s-team selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('c10', 'team', 'Select 10th Team')" required>
                    </div>

                    <div class="predict-group" style="border-color: var(--gold); background: rgba(197, 155, 39, 0.02);">
                        <h3 style="color: var(--gold); border-color: rgba(197, 155, 39, 0.3);">üÉè Strategic Wildcards</h3>
                        <label>Race: Biggest Loser</label>
                        <input type="text" id="wl" class="s-wildcard selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('wl', 'wildcard', 'Select Race Biggest Loser')" required>

                        <div id="sprint-box" class="hidden" style="margin-top: 25px; padding-top: 25px; border-top: 1px dashed var(--border);">
                            <h4 style="margin:0 0 15px; color:var(--red); font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">‚ö° Sprint Weekend Bonus</h4>
                            <label>Sprint: Biggest Gainer</label>
                            <input type="text" id="sg" class="s-wildcard selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('sg', 'wildcard', 'Select Sprint Gainer')">
                            <label>Sprint: Biggest Loser</label>
                            <input type="text" id="sl" class="s-wildcard selector-input" readonly placeholder="Tap to select..." onclick="openSelectorModal('sl', 'wildcard', 'Select Sprint Loser')">
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn" id="sub-btn">üîí Transmit Strategy</button>
        </form>
    </div>

    <div id="live" class="tab">
        <h2 class="section-title">Live Grid</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Opponent strategies locked for this session:</p>
        <div id="live-list"></div>
        
        <div id="admin-panel" class="hidden" style="margin-top:40px; border:2px solid var(--red); padding:30px; background:rgba(225,6,0,0.05); border-radius:12px; text-align: center;">
            <h3 style="color: var(--red); font-weight: 900; letter-spacing: 1px; margin-top:0; font-size: 1.5rem;">‚ö†Ô∏è STEWARDS CONTROL</h3>
            <button onclick="finalize()" style="background:var(--red); color:white; padding:14px 28px; cursor:pointer; border: none; font-weight: 900; border-radius: 8px; font-family: 'Titillium Web'; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 30px; width: 100%; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(225, 6, 0, 0.4);">üèÅ Finalize Race Weekend</button>
            
            <h4 style="text-align: left; color: var(--text-main); text-transform: uppercase; border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 15px;">User Management</h4>
            <div id="admin-user-list" style="display: flex; flex-direction: column; gap: 15px; text-align: left;">
                </div>
        </div>
    </div>

    <div id="standings" class="tab">
        <h2 class="section-title">2026 World Championship</h2>
        
        <div style="background: linear-gradient(135deg, #15151e 0%, #2b2b36 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid var(--red); box-shadow: 0 8px 20px rgba(0,0,0,0.15); position: relative; overflow: hidden;">
            <div style="position: absolute; top: -10px; right: -10px; font-size: 5rem; opacity: 0.05;">üéôÔ∏è</div>
            <h3 style="margin: 0 0 15px 0; color: var(--red); text-transform: uppercase; letter-spacing: 2px; font-size: 1.1rem; font-weight: 900;">Paddock Post-Race Analysis</h3>
            <div id="dts-storyline" style="font-family: serif; font-size: 1.05rem; line-height: 1.6; font-style: italic; color: #d1d1d6;">
                <div class="skeleton" style="width:100%; height:15px; margin-bottom:10px;"></div>
                <div class="skeleton" style="width:90%; height:15px; margin-bottom:10px;"></div>
                <div class="skeleton" style="width:60%; height:15px;"></div>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th style="width: 15%; text-align: center;">Pos</th><th>Strategist</th><th style="width: 25%; text-align: right;">Points</th></tr>
                </thead>
                <tbody id="leaderboard"></tbody>
            </table>
        </div>
    </div>

    <div id="calendar" class="tab">
        <h2 class="section-title">2026 Calendar</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th style="width: 10%; text-align: center;">Rnd</th><th>Grand Prix & Local Time (IST)</th></tr>
                </thead>
                <tbody id="cal-body"></tbody>
            </table>
        </div>
    </div>

    <div id="grid" class="tab">
        <h2 class="section-title">2026 Official Grid</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Complete line-up featuring all 11 Constructors and 22 Drivers.</p>
        <div id="grid-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;"></div>
    </div>

    <div id="rules" class="tab">
        <h2 class="section-title">Sporting Regulations</h2>
        <div class="predict-group" style="line-height: 1.8;">
            <h3>‚è∞ 1. Parc Ferm√© (The Deadline)</h3>
            <ul><li>Strategies are <strong>strictly locked</strong> the exact minute that <strong>Qualifying</strong> begins. No exceptions.</li></ul>
            <h3 style="margin-top:20px;">üèéÔ∏è 2. Driver Scoring Matrix</h3>
            <ul>
                <li><strong>Exact Match Bonus:</strong> <span style="color: #009940; font-weight: bold;">+2 Points</span>.</li>
                <li><strong>Differential Penalty:</strong> <span style="color: var(--red); font-weight: bold;">-1 Point</span> for every position your prediction misses by.</li>
            </ul>
            <h3 style="margin-top:20px;">üí• 3. The 'Engine Blow' (DNF Rule)</h3>
            <ul><li>If a driver retires, crashes, or fails to classify (DNF), the Stewards automatically score them as finishing in <strong>P20</strong>.</li></ul>
            <h3 style="margin-top:20px;">üõ†Ô∏è 4. Constructor Scoring</h3>
            <ul><li>Constructor performance is ranked purely by combining the finishing positions of their two cars in that specific race session.</li></ul>
            <h3 style="margin-top:20px;">üÉè 5. Strategic Wildcards</h3>
            <ul><li><strong>Biggest Race Loser:</strong> <span style="color: #009940; font-weight: bold;">+5 Points</span> for correctly identifying the driver who plummets the most positions from their grid start to the checkered flag.</li></ul>
        </div>
    </div>

    <div id="archive" class="tab">
        <h2 class="section-title">2025 World Championship</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">The official final classification of the previous F1 season.</p>

        <div class="predict-group" style="padding: 0; overflow: hidden;">
            <h3 style="padding: 20px 25px; margin: 0; background: var(--surface-inner); border-bottom: 1px solid var(--border); color: var(--red); font-size: 1.3rem;">üèÜ Drivers' Championship</h3>
            <div class="table-wrapper" style="margin: 0; box-shadow: none; border: none; border-radius: 0;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 10%; text-align: center;">Pos</th>
                            <th style="width: 45%;">Driver</th>
                            <th>Team</th>
                            <th style="width: 15%; text-align: right;">Pts</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="text-align:center; font-weight:900; color: #c59b27;">1</td><td style="font-weight: 700; color: var(--text-main); border-left: 4px solid #FF8000;">Lando Norris</td><td style="color: var(--text-muted);">McLaren</td><td style="text-align:right; font-weight:900; font-size: 1.1rem;">423</td></tr>
                        <tr><td style="text-align:center; font-weight:900; color: #999999;">2</td><td style="font-weight: 700; color: var(--text-main); border-left: 4px solid #1E41FF;">Max Verstappen</td><td style="color: var(--text-muted);">Red Bull Racing</td><td style="text-align:right; font-weight:900; font-size: 1.1rem;">421</td></tr>
                        <tr><td style="text-align:center; font-weight:900; color: #b87333;">3</td><td style="font-weight: 700; color: var(--text-main); border-left: 4px solid #FF8000;">Oscar Piastri</td><td style="color: var(--text-muted);">McLaren</td><td style="text-align:right; font-weight:900; font-size: 1.1rem;">410</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">4</td><td style="font-weight: 600; border-left: 4px solid #27F4D2;">George Russell</td><td style="color: var(--text-muted);">Mercedes</td><td style="text-align:right; font-weight:700;">319</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">5</td><td style="font-weight: 600; border-left: 4px solid #E80020;">Charles Leclerc</td><td style="color: var(--text-muted);">Ferrari</td><td style="text-align:right; font-weight:700;">242</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">6</td><td style="font-weight: 600; border-left: 4px solid #E80020;">Lewis Hamilton</td><td style="color: var(--text-muted);">Ferrari</td><td style="text-align:right; font-weight:700;">220</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">7</td><td style="font-weight: 600; border-left: 4px solid #00A0E9;">Carlos Sainz</td><td style="color: var(--text-muted);">Williams</td><td style="text-align:right; font-weight:700;">195</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">8</td><td style="font-weight: 600; border-left: 4px solid #006F62;">Fernando Alonso</td><td style="color: var(--text-muted);">Aston Martin</td><td style="text-align:right; font-weight:700;">130</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">9</td><td style="font-weight: 600; border-left: 4px solid #00A0E9;">Alex Albon</td><td style="color: var(--text-muted);">Williams</td><td style="text-align:right; font-weight:700;">85</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">10</td><td style="font-weight: 600; border-left: 4px solid #FF87BC;">Pierre Gasly</td><td style="color: var(--text-muted);">Alpine</td><td style="text-align:right; font-weight:700;">70</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="predict-group" style="padding: 0; overflow: hidden; margin-top: 35px;">
            <h3 style="padding: 20px 25px; margin: 0; background: var(--surface-inner); border-bottom: 1px solid var(--border); color: var(--red); font-size: 1.3rem;">üè≠ Constructors' Championship</h3>
            <div class="table-wrapper" style="margin: 0; box-shadow: none; border: none; border-radius: 0;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 10%; text-align: center;">Pos</th>
                            <th>Constructor</th>
                            <th style="width: 25%; text-align: right;">Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="text-align:center; font-weight:900; color: #c59b27;">1</td><td style="font-weight: 700; color: var(--text-main); border-left: 4px solid #FF8000;">McLaren</td><td style="text-align:right; font-weight:900; font-size: 1.1rem;">833</td></tr>
                        <tr><td style="text-align:center; font-weight:900; color: #999999;">2</td><td style="font-weight: 700; color: var(--text-main); border-left: 4px solid #27F4D2;">Mercedes</td><td style="text-align:right; font-weight:900; font-size: 1.1rem;">469</td></tr>
                        <tr><td style="text-align:center; font-weight:900; color: #b87333;">3</td><td style="font-weight: 700; color: var(--text-main); border-left: 4px solid #1E41FF;">Red Bull Racing</td><td style="text-align:right; font-weight:900; font-size: 1.1rem;">451</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">4</td><td style="font-weight: 600; border-left: 4px solid #E80020;">Ferrari</td><td style="text-align:right; font-weight:700;">398</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">5</td><td style="font-weight: 600; border-left: 4px solid #00A0E9;">Williams</td><td style="text-align:right; font-weight:700;">137</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">6</td><td style="font-weight: 600; border-left: 4px solid #FF87BC;">Alpine</td><td style="text-align:right; font-weight:700;">128</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">7</td><td style="font-weight: 600; border-left: 4px solid #006F62;">Aston Martin</td><td style="text-align:right; font-weight:700;">105</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">8</td><td style="font-weight: 600; border-left: 4px solid #1434CB;">Racing Bulls</td><td style="text-align:right; font-weight:700;">82</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">9</td><td style="font-weight: 600; border-left: 4px solid #B6BABD;">Haas</td><td style="text-align:right; font-weight:700;">80</td></tr>
                        <tr><td style="text-align:center; font-weight:700; color: var(--text-muted);">10</td><td style="font-weight: 600; border-left: 4px solid #00FF00;">Sauber (Audi)</td><td style="text-align:right; font-weight:700;">27</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div id="auth" class="modal" style="display: none;">
    <div class="modal-box">
        <h2 style="margin-top: 0; font-size: 2rem; text-transform: uppercase; letter-spacing: 1px;">Paddock Entry</h2>
        <input type="text" id="u-name" placeholder="Driver Name" style="margin-bottom: 15px; padding: 14px; width: 100%; border-radius: 8px; border: 1px solid var(--border); font-size: 1rem; box-sizing: border-box;">
        <input type="password" id="u-pass" placeholder="Password" style="padding: 14px; width: 100%; border-radius: 8px; border: 1px solid var(--border); font-size: 1rem; box-sizing: border-box;">
        <button onclick="login()" class="btn" style="margin-top: 25px;">Enter Garage</button>
        <button onclick="reg()" class="btn" style="background: var(--surface-inner); color: var(--text-main); margin-top: 15px; box-shadow: none; border: 1px solid var(--border);">Register New Driver</button>
        
        <div style="margin-top: 25px; text-align: center;">
            <a href="#" onclick="forgotPassword()" style="color: var(--text-muted); font-size: 0.95rem; text-decoration: none; border-bottom: 1px dashed var(--text-muted); font-weight: 700;">Forgot Password?</a>
        </div>
    </div>
</div>

<script>
    const teamsData = [
        { name: "Red Bull Racing", color: "#1E41FF", drivers: [{name: "Max Verstappen", num: 1}, {name: "Isack Hadjar", num: 20}] },
        { name: "McLaren", color: "#FF8000", drivers: [{name: "Lando Norris", num: 4}, {name: "Oscar Piastri", num: 81}] },
        { name: "Ferrari", color: "#E80020", drivers: [{name: "Charles Leclerc", num: 16}, {name: "Lewis Hamilton", num: 44}] },
        { name: "Mercedes", color: "#27F4D2", drivers: [{name: "George Russell", num: 63}, {name: "Kimi Antonelli", num: 12}] },
        { name: "Aston Martin", color: "#006F62", drivers: [{name: "Fernando Alonso", num: 14}, {name: "Lance Stroll", num: 18}] },
        { name: "Williams", color: "#00A0E9", drivers: [{name: "Carlos Sainz", num: 55}, {name: "Alex Albon", num: 23}] },
        { name: "Alpine", color: "#FF87BC", drivers: [{name: "Pierre Gasly", num: 10}, {name: "Franco Colapinto", num: 43}] },
        { name: "Racing Bulls", color: "#1434CB", drivers: [{name: "Liam Lawson", num: 30}, {name: "Arvid Lindblad", num: 8}] },
        { name: "Haas", color: "#B6BABD", drivers: [{name: "Esteban Ocon", num: 31}, {name: "Oliver Bearman", num: 87}] },
        { name: "Audi", color: "#00FF00", drivers: [{name: "Nico Hulkenberg", num: 27}, {name: "Gabriel Bortoleto", num: 5}] },
        { name: "Cadillac", color: "#FFB800", drivers: [{name: "Sergio Perez", num: 11}, {name: "Valtteri Bottas", num: 77}] }
    ];

    const detailedTeams = teamsData.map(t => ({ name: t.name, color: t.color }));
    detailedTeams.sort((a, b) => a.name.localeCompare(b.name));

    const detailedDrivers = [];
    teamsData.forEach(t => t.drivers.forEach(d => detailedDrivers.push({ name: d.name, num: d.num, color: t.color })));
    detailedDrivers.sort((a, b) => a.name.localeCompare(b.name));

    let user = JSON.parse(localStorage.getItem('f1_user'));
    let raceLock = null;

    function showToast(message, type = 'error') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = message;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 4000);
    }

    function showSupportModal() { showToast('Constructors Fund integration coming soon. Thank you for the support!', 'success'); }

    document.addEventListener('DOMContentLoaded', () => {
        if(!user) { 
            document.getElementById('auth').style.display = 'flex'; 
        } else { 
            document.getElementById('logged-in-name').innerText = user.name;
            document.getElementById('user-menu').classList.remove('hidden');
            start(); 
        }
    });

    function start() { 
        checkAdm(); 
        loadRace(); 
        loadBoard(); 
        buildGridTab(); 
        
        const savedTab = localStorage.getItem('f1_active_tab') || 'predict';
        tab(savedTab); 
    }

    function toggleUserMenu() {
        document.getElementById('user-menu').classList.toggle('show');
    }

    let currentInputId = null;
    
    function openSelectorModal(inputId, type, title) {
        currentInputId = inputId;
        document.getElementById('selector-title').innerText = title;
        const grid = document.getElementById('selector-grid');
        grid.innerHTML = '';
        
        let picked = [];
        let items = detailedDrivers;

        if (type === 'team') {
            const pickedNodes = Array.from(document.querySelectorAll('.s-team'));
            picked = pickedNodes.map(inp => inp.value).filter(v => v !== '' && v !== document.getElementById(inputId).value);
            items = detailedTeams;
        } else if (type === 'driver') {
            const pickedNodes = Array.from(document.querySelectorAll('.s-driver'));
            picked = pickedNodes.map(inp => inp.value).filter(v => v !== '' && v !== document.getElementById(inputId).value);
        } else if (type === 'wildcard') {
            picked = []; 
        }
        
        items.forEach(item => {
            const isDisabled = picked.includes(item.name);
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `modal-grid-btn ${isDisabled ? 'disabled' : ''}`;
            btn.style.setProperty('--team-color', item.color);
            
            let numHtml = item.num ? `<span class="num">${item.num}</span>` : '';
            btn.innerHTML = `<span>${item.name}</span> ${numHtml}`;
            
            if (!isDisabled) {
                btn.onclick = () => {
                    const inputField = document.getElementById(currentInputId);
                    inputField.value = item.name;
                    inputField.setAttribute('value', item.name); 
                    closeSelectorModal();
                };
            }
            grid.appendChild(btn);
        });
        
        document.getElementById('grid-selector-modal').classList.remove('hidden');
    }

    function closeSelectorModal() {
        document.getElementById('grid-selector-modal').classList.add('hidden');
        currentInputId = null;
    }

    window.onclick = function(event) {
        const modal = document.getElementById('grid-selector-modal');
        if (event.target === modal) { closeSelectorModal(); }

        const userMenu = document.getElementById('user-menu');
        if (userMenu && !userMenu.contains(event.target)) {
            userMenu.classList.remove('show');
        }
    }

    async function fetchWeather(locationQuery) {
        try {
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationQuery)}&count=1`);
            const geoData = await geoRes.json();
            if(!geoData.results || geoData.results.length === 0) throw new Error("Location not found");
            const { latitude, longitude } = geoData.results[0];

            const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,precipitation,weather_code,wind_speed_10m`);
            const wData = await weatherRes.json();
            const curr = wData.current;

            const code = curr.weather_code;
            let icon = '‚òÅÔ∏è';
            if(code === 0) icon = '‚òÄÔ∏è';
            else if(code > 0 && code < 4) icon = '‚õÖ';
            else if(code >= 51 && code <= 67) icon = 'üåßÔ∏è';
            else if(code >= 71 && code <= 77) icon = '‚ùÑÔ∏è';
            else if(code >= 95) icon = '‚õàÔ∏è';

            document.getElementById('weather-widget').innerHTML = `
                <div style="font-size:2rem; font-weight:900; margin-bottom: 5px;">${icon} ${curr.temperature_2m}¬∞C</div>
                <div style="color:var(--text-muted); font-size:0.95rem; font-weight: 700;">Wind: ${curr.wind_speed_10m} km/h | Precip: ${curr.precipitation}mm</div>
            `;
        } catch(e) {
            document.getElementById('weather-widget').innerHTML = "<span style='color:var(--text-muted);'>Radar offline.</span>";
        }
    }

    async function loadRace() {
        try {
            const r = await fetch('/api/next-race').then(res=>res.json());
            document.getElementById('r-round').innerText = `Round ${r.round} of 24`;
            document.getElementById('r-header').innerText = `${r.circuit}, ${r.country}`;
            document.getElementById('r-record').innerHTML = `‚è±Ô∏è <b>Lap Record:</b> ${r.record || 'No record available'}`;
            
            // Evaluates based on universal Qualifying deadline
            raceLock = new Date(r.lockTime);
            
            fetchWeather(r.country);
            
            if (r.hasSprint) { 
                document.getElementById('sprint-box').classList.remove('hidden');
                document.getElementById('sg').required = true;
                document.getElementById('sl').required = true;
            } else { 
                document.getElementById('sprint-box').classList.add('hidden');
                document.getElementById('sg').required = false;
                document.getElementById('sl').required = false;
            }
            
            if (new Date() >= raceLock) {
                document.getElementById('p-form').style.display = 'none';
                document.getElementById('locked-msg').classList.remove('hidden');
            }
        } catch (e) { showToast("Failed to load circuit telemetry.", "error"); }
    }

    function tab(t, btnElement) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('#main-nav button').forEach(b => b.classList.remove('active-nav'));
        
        document.getElementById(t).classList.add('active');
        
        if(btnElement) {
            btnElement.classList.add('active-nav');
        } else {
            document.querySelectorAll('#main-nav button').forEach(b => {
                if(b.getAttribute('onclick') && b.getAttribute('onclick').includes(`'${t}'`)) b.classList.add('active-nav');
            });
        }

        localStorage.setItem('f1_active_tab', t);

        if(t==='live') loadLive(); 
        if(t==='standings') loadBoard(); 
        if(t==='calendar') loadCalendar();
    }

    async function loadLive() {
        const list = document.getElementById('live-list');
        list.innerHTML = `<div class="predict-group"><div class="skeleton" style="width:40%; margin-bottom:15px;"></div><div class="skeleton" style="width:100%; height:60px;"></div></div>`;
        const d = await fetch('/api/predictions').then(r=>r.json());
        
        if (d.length === 0) { 
            list.innerHTML = "<div class='predict-group' style='text-align: center; color: var(--text-muted);'>No telemetry submitted yet for this session.</div>"; 
        } else {
            list.innerHTML = d.map(x=>`
                <div class="predict-group" style="border-left: 4px solid var(--red); padding: 20px;">
                    <h3 style="margin-top:0; display:flex; align-items:center; gap:8px;">üèéÔ∏è <span style="text-transform:uppercase;">${x.user_name}</span></h3>
                    <div class="live-grid-container">
                        
                        <div class="live-card-section">
                            <strong class="live-card-title">Drivers</strong>
                            <div style="line-height:1.8; color: var(--text-main);">
                                <span style="color:var(--text-muted)">P1:</span> <b>${x.p1}</b> | <span style="color:var(--text-muted)">P2:</span> <b>${x.p2}</b> | <span style="color:var(--text-muted)">P3:</span> <b>${x.p3}</b><br>
                                <span style="color:var(--text-muted)">P11:</span> <b>${x.p11}</b> | <span style="color:var(--text-muted)">P12:</span> <b>${x.p12}</b><br>
                                <span style="color:var(--text-muted)">P19:</span> <b>${x.p19}</b> | <span style="color:var(--text-muted)">P20:</span> <b>${x.p20}</b>
                            </div>
                        </div>

                        <div class="live-card-section">
                            <strong class="live-card-title">Constructors</strong>
                            <div style="line-height:1.8; color: var(--text-main);">
                                <span style="color:var(--text-muted)">1st:</span> <b>${x.c1}</b> | <span style="color:var(--text-muted)">2nd:</span> <b>${x.c2}</b><br>
                                <span style="color:var(--text-muted)">5th:</span> <b>${x.c5}</b> | <span style="color:var(--text-muted)">6th:</span> <b>${x.c6}</b><br>
                                <span style="color:var(--text-muted)">10th:</span> <b>${x.c10}</b>
                            </div>
                        </div>

                        <div class="live-card-section">
                            <strong class="live-card-title" style="color:var(--gold); border-bottom-color: rgba(197, 155, 39, 0.3);">Wildcards</strong>
                            <div style="line-height:1.8; color: var(--text-main);">
                                <span style="color:var(--text-muted)">Race Loser:</span> <b style="color:var(--red)">${x.w_race_loser}</b>
                                ${x.w_sprint_gainer ? `<br><span style="color:var(--text-muted)">Sprint Gainer:</span> <b style="color:#009940">${x.w_sprint_gainer}</b><br><span style="color:var(--text-muted)">Sprint Loser:</span> <b style="color:var(--red)">${x.w_sprint_loser}</b>` : ''}
                            </div>
                        </div>

                    </div>
                </div>
            `).join('');
        }
    }

    async function loadBoard() {
        try {
            const storyRes = await fetch('/api/storyline').then(r=>r.json());
            const formattedStory = storyRes.story.replace(/\n/g, '<br>');
            document.getElementById('dts-storyline').innerHTML = formattedStory;
        } catch(e) {}

        const board = document.getElementById('leaderboard');
        const skel = `<tr><td><div class="skeleton" style="width:30px;"></div></td><td><div class="skeleton" style="width:150px;"></div></td><td><div class="skeleton" style="width:40px; float:right;"></div></td></tr>`;
        board.innerHTML = skel.repeat(5);
        
        const d = await fetch('/api/season-leaderboard').then(r=>r.json());
        if (d.length === 0) { board.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color: var(--text-muted);">No telemetry data available yet.</td></tr>'; } 
        else {
            board.innerHTML = d.map((x,i)=>{
                let isVip = (x.is_vip === 1); 
                let nameHtml = isVip ? `<span class="vip-gold">${x.name}</span><span class="vip-badge">Constructors Club</span>` : `<span style="font-weight: 700;">${x.name}</span>`;
                let posColor = i===0 ? '#c59b27' : (i===1 ? '#999999' : (i===2 ? '#b87333' : 'var(--text-muted)'));
                return `<tr><td style="text-align: center; font-weight: 900; color: ${posColor};">${i+1}</td><td>${nameHtml}</td><td style="text-align: right;"><b style="font-size:1.2rem; font-weight: 900; color: var(--text-main);">${x.total_score}</b></td></tr>`;
            }).join('');
        }
    }

    async function loadCalendar() {
        const body = document.getElementById('cal-body');
        body.innerHTML = `<tr><td colspan="2"><div class="skeleton" style="width:100%; height:40px; margin-bottom:10px;"></div><div class="skeleton" style="width:100%; height:40px;"></div></td></tr>`;
        
        const d = await fetch('/api/calendar').then(r=>r.json());
        body.innerHTML = d.map(x => {
            const formatTime = (iso) => iso ? new Date(iso).toLocaleString('en-IN', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'TBC';
            let sess = x.hasSprint ? `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem; color: var(--text-muted); margin-top: 12px; background: var(--surface-inner); padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">FP1</strong> ${formatTime(x.sessions?.fp1)}</div>
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">SQ</strong> ${formatTime(x.sessions?.sprintQuali)}</div>
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">Sprint</strong> ${formatTime(x.sessions?.sprint)}</div>
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">Quali</strong> ${formatTime(x.sessions?.quali)}</div>
                    <div style="grid-column: 1 / -1; margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px;"><strong style="color:var(--red); font-weight: 900; letter-spacing: 1px; width:55px; display:inline-block;">RACE</strong> <span style="color: var(--text-main); font-weight: 700;">${formatTime(x.sessions?.race)}</span></div>
                </div>
            ` : `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem; color: var(--text-muted); margin-top: 12px; background: var(--surface-inner); padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">FP1</strong> ${formatTime(x.sessions?.fp1)}</div>
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">FP2</strong> ${formatTime(x.sessions?.fp2)}</div>
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">FP3</strong> ${formatTime(x.sessions?.fp3)}</div>
                    <div><strong style="color:var(--text-main); width:55px; display:inline-block;">Quali</strong> ${formatTime(x.sessions?.quali)}</div>
                    <div style="grid-column: 1 / -1; margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px;"><strong style="color:var(--red); font-weight: 900; letter-spacing: 1px; width:55px; display:inline-block;">RACE</strong> <span style="color: var(--text-main); font-weight: 700;">${formatTime(x.sessions?.race)}</span></div>
                </div>
            `;
            return `<tr><td style="vertical-align: top; font-size: 1.4rem; font-weight: 900; text-align: center; color: var(--text-muted);">${x.round}</td><td><strong style="font-size:1.3rem; display:inline-block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main);">${x.name}</strong>${x.hasSprint ? '<span class="sprint-badge">Sprint Weekend</span>' : ''}${sess}</td></tr>`;
        }).join('');
    }

    function buildGridTab() {
        document.getElementById('grid-container').innerHTML = teamsData.map(t => {
            return `
            <div class="predict-group" style="border-left: 6px solid ${t.color}; padding: 20px; border-radius: 12px; margin-bottom: 0;">
                <h3 style="margin: 0 0 20px 0; font-size: 1.4rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: var(--text-main); border:none;">${t.name}</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="background: var(--surface-inner); padding: 12px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
                        <span style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">${t.drivers[0].name}</span><span style="background: ${t.color}; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); padding: 2px 10px; border-radius: 4px; font-weight: 900; font-size: 1.1rem;">${t.drivers[0].num}</span>
                    </div>
                    <div style="background: var(--surface-inner); padding: 12px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
                        <span style="font-weight: 700; font-size: 1.1rem; color: var(--text-main);">${t.drivers[1].name}</span><span style="background: ${t.color}; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); padding: 2px 10px; border-radius: 4px; font-weight: 900; font-size: 1.1rem;">${t.drivers[1].num}</span>
                    </div>
                </div>
            </div>
        `}).join('');
    }

    document.getElementById('p-form').addEventListener('submit', async(e)=>{
        e.preventDefault();
        
        const requiredInputs = ['p1', 'p2', 'p3', 'p11', 'p12', 'p19', 'p20', 'c1', 'c2', 'c5', 'c6', 'c10', 'wl'];
        if (!document.getElementById('sprint-box').classList.contains('hidden')) { 
            requiredInputs.push('sg', 'sl'); 
        }
        
        for (let id of requiredInputs) {
            if (!val(id)) { 
                showToast('‚ö†Ô∏è Strategy Incomplete. Please fill all required fields.', 'error'); 
                return; 
            }
        }

        const body = {
            user_name: user.name, password: user.password,
            p1:val('p1'), p2:val('p2'), p3:val('p3'), p11:val('p11'), p12:val('p12'), p19:val('p19'), p20:val('p20'),
            c1:val('c1'), c2:val('c2'), c5:val('c5'), c6:val('c6'), c10:val('c10'),
            w_race_loser:val('wl'), w_sprint_gainer: val('sg'), w_sprint_loser: val('sl')
        };
        const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if(res.ok) { showToast('‚úÖ Strategy Transmitted and Locked', 'success'); } 
        else { const err = await res.json(); showToast('Error: ' + (err.message || 'Locked or Failed'), 'error'); }
    });
    
    function val(id) { return document.getElementById(id).value; }

    async function finalize() {
        if(!confirm('‚ö†Ô∏è WARNING: Finalize the race weekend and calculate scores?')) return;
        showToast('Processing telemetry...', 'success');
        const res = await fetch('/api/finalize', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_name:user.name, password:user.password}) });
        const d = await res.json();
        if(res.ok) { showToast('‚úÖ Finalization Complete!', 'success'); setTimeout(() => location.reload(), 2000); } 
        else { showToast('‚ùå Error: ' + d.message, 'error'); }
    }

    async function login() {
        const name = document.getElementById('u-name').value.trim(); 
        const password = document.getElementById('u-pass').value.trim();

        if (!name || !password) {
            showToast('‚ö†Ô∏è Please enter both Driver Name and Password.', 'error');
            return;
        }

        const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, password}) });
        if(res.ok) { 
            localStorage.setItem('f1_user', JSON.stringify({name, password})); 
            location.reload(); 
        } else { 
            showToast('‚ùå Invalid Credentials. Access Denied.', 'error'); 
        }
    }
    
    async function reg() {
        const name = document.getElementById('u-name').value.trim();
        const password = document.getElementById('u-pass').value.trim();

        if (name.length < 3 || password.length < 4) {
            showToast('‚ö†Ô∏è Name (min 3 chars) and Password (min 4 chars) required.', 'error');
            return;
        }

        const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, password}) });
        
        if(res.ok) { 
            showToast('‚úÖ Registration Successful! Entering Paddock...', 'success');
            localStorage.setItem('f1_user', JSON.stringify({name, password})); 
            setTimeout(() => location.reload(), 1200); 
        } else { 
            showToast('‚ùå Username taken. Please choose another.', 'error'); 
        }
    }

    function forgotPassword() {
        const username = prompt("üèéÔ∏è Paddock Security: \n\nEnter your Driver Name to request a password reset from the Stewards.");
        if(username) {
            showToast('üö® Reset request flagged! Please message the Admin in Discord for your temporary password.', 'success');
        }
    }
    
    function logout() { localStorage.clear(); location.reload(); }
    
    function checkAdm() { 
        if(user && user.name === 'admin') {
            document.getElementById('admin-panel').classList.remove('hidden'); 
            loadAdminUserList(); 
        }
    }

    async function loadAdminUserList() {
        try {
            const resp = await fetch(`/api/admin/users?user=${encodeURIComponent(user.name)}&pass=${encodeURIComponent(user.password)}`);
            if(!resp.ok) return;
            const users = await resp.json();
            const list = document.getElementById('admin-user-list');
            
            if(users.length === 0) {
                list.innerHTML = `<p style="color:var(--text-muted); text-align:center;">No drivers registered yet.</p>`;
                return;
            }

            list.innerHTML = users.map(u => `
                <div style="background: var(--surface); padding: 15px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong style="color:var(--text-main); font-size:1.1rem; display: block; margin-bottom: 4px;">${u.name} ${u.is_vip ? 'üèÜ' : ''}</strong> 
                        <span style="color:var(--text-muted); font-size:0.9rem; font-weight: 700;">Score: ${u.total_score} pts</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="toggleVip('${u.name}', ${u.is_vip})" style="background:${u.is_vip ? 'var(--surface-inner)' : 'rgba(197, 155, 39, 0.1)'}; color:${u.is_vip ? 'var(--text-muted)' : 'var(--gold)'}; border:1px solid ${u.is_vip ? 'var(--border)' : 'var(--gold)'}; padding:8px 12px; border-radius:6px; cursor:pointer; font-family: 'Titillium Web'; font-weight:bold; transition: all 0.2s;">
                            ${u.is_vip ? 'Remove VIP' : 'Make VIP'}
                        </button>
                        <button onclick="resetPoints('${u.name}')" style="background:var(--surface-inner); color:var(--red); border:1px solid var(--border); padding:8px 12px; border-radius:6px; cursor:pointer; font-family: 'Titillium Web'; font-weight:bold; transition: all 0.2s;">
                            Reset Score
                        </button>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error("Admin Load Error:", e); }
    }

    async function toggleVip(targetUser, currentStatus) {
        if(!confirm(`Toggle VIP status for ${targetUser}?`)) return;
        try {
            await fetch('/api/admin/toggle-vip', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ adminUser: user.name, adminPass: user.password, targetUser, vipStatus: !currentStatus })
            });
            loadAdminUserList();
            showToast(`VIP Status updated for ${targetUser}`, 'success');
        } catch (e) { showToast('Error updating VIP status', 'error'); }
    }

    async function resetPoints(targetUser) {
        if(!confirm(`‚ö†Ô∏è ARE YOU SURE? This completely resets ${targetUser}'s score to 0.`)) return;
        try {
            await fetch('/api/admin/reset-user', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ adminUser: user.name, adminPass: user.password, targetUser })
            });
            loadAdminUserList();
            showToast(`${targetUser} has been reset to 0 points.`, 'success');
        } catch (e) { showToast('Error resetting user', 'error'); }
    }

    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');
    const isStandalone = () => ('standalone' in window.navigator && window.navigator.standalone) || window.matchMedia('(display-mode: standalone)').matches;

    if (!isStandalone() && installBtn) { installBtn.classList.remove('hidden'); }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); 
        deferredPrompt = e; 
    });

    function installApp() {
        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());

        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') { installBtn.classList.add('hidden'); }
                deferredPrompt = null;
            });
        } else if (isIos()) {
            showToast('üçé iOS: Tap the "Share" icon at the bottom of Safari, then scroll down and tap "Add to Home Screen".', 'success');
        } else {
            showToast('ü§ñ Android: Tap the 3 dots (‚ãÆ) in your browser menu and tap "Add to Home screen" or "Install App".', 'success');
        }
    }
</script>
</body>
</html>