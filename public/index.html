<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 2026 League</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --red: #e10600; --bg: #15151e; --card: #1f1f23; --text: #fff; }
        body { margin:0; font-family:'Titillium Web',sans-serif; background:var(--bg); color:var(--text); }
        
        header { background:var(--red); padding:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap;}
        h1 { margin: 0; font-size: 1.5rem; font-style: italic; }
        nav { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;}
        nav button { background:rgba(0,0,0,0.2); border:none; color:white; font-weight:bold; cursor:pointer; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; }
        nav button:hover { background:rgba(255,255,255,0.3); }
        
        main { padding:20px; max-width:900px; margin:0 auto; }
        .tab { display:none; animation: fadeIn 0.3s; } 
        .active { display:block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
        @media (max-width: 700px) { .form-grid { grid-template-columns: 1fr; } }
        
        select, input { width:100%; padding:12px; margin:5px 0 15px; background:#2a2a2f; border:1px solid #444; color:white; border-radius:4px; box-sizing: border-box; }
        select:focus { border-color: var(--red); outline: none; }
        option:disabled { color: #555; background: #1a1a1a; }
        label { font-size:0.9rem; color:#aaa; font-weight:bold; display:block; text-transform:uppercase; margin-top: 10px; }
        
        .btn { background:var(--red); color:white; border:none; padding:15px; width:100%; font-weight:bold; cursor:pointer; border-radius:4px; margin-top:20px; font-size: 1.1rem; }
        .btn:hover { background: #b30000; }
        
        .admin-box { margin-top:40px; border:2px solid var(--red); padding:20px; background:rgba(225,6,0,0.1); border-radius:8px; display:none; text-align: center; }
        
        table { width:100%; border-collapse:collapse; background: var(--card); border-radius: 8px; overflow: hidden; margin-top: 20px; }
        th { background:#2a2a2f; color:var(--red); padding:15px; text-align:left; text-transform: uppercase; font-size: 0.85rem; }
        td { padding:15px; border-bottom:1px solid #333; }
        
        .rules-list { line-height: 1.6; background: var(--card); padding: 20px 40px; border-radius: 8px; border-left: 4px solid var(--red); }
        .rules-list li { margin-bottom: 15px; }
        .rules-list h3 { color: var(--red); margin-bottom: 5px; margin-top: 20px;}
        
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:999; }
        .modal-box { background:#222; padding:40px; border-radius:8px; width:90%; max-width:400px; text-align:center; border:1px solid #444; }
        .hidden { display:none; }
        .sprint-badge { background: #e10600; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; text-transform: uppercase; }
        
        .session-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem; color: #ccc; margin-top: 10px; background: #1a1a1f; padding: 10px; border-radius: 4px;}
        .session-grid div strong { color: #fff; display: inline-block; width: 65px;}
    </style>
</head>
<body>

<header>
    <h1>üèéÔ∏è F1 2026 LEAGUE</h1>
    <nav>
        <button onclick="tab('predict')">Predict</button>
        <button onclick="tab('live')">Live</button>
        <button onclick="tab('standings')">Standings</button>
        <button onclick="tab('calendar')">üìÖ Calendar</button>
        <button onclick="tab('grid')">üèéÔ∏è The Grid</button>
        <button onclick="tab('rules')">üìú Rules</button>
        <button onclick="tab('archive')">üèÜ Archive</button>
        <button onclick="logout()">Logout</button>
    </nav>
</header>

<main>
    <div id="predict" class="tab active">
        <div style="background: #1a1a1f; padding: 20px; border-radius: 8px; border-left: 5px solid var(--red); margin-bottom: 20px;">
            <p id="r-round" style="color: var(--red); font-weight: bold; font-size: 0.9rem; text-transform: uppercase; margin: 0 0 5px 0;">Loading...</p>
            <h2 id="r-header" style="margin: 0 0 8px 0; font-size: 1.8rem; text-transform: uppercase;">Loading Circuit...</h2>
            <p id="r-record" style="margin: 0; color: #aaa; font-size: 1rem;">‚è±Ô∏è <b>Lap Record:</b> Loading...</p>
        </div>

        <div id="locked-msg" style="display:none; background:var(--red); padding:15px; text-align:center; font-weight: bold; border-radius: 4px; margin-bottom: 20px;">üö´ PREDICTIONS LOCKED (CARS ON TRACK)</div>
        
        <form id="p-form">
            <div class="form-grid">
                <div>
                    <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px;">Driver Positions</h3>
                    <label>P1 Winner</label><select id="p1" class="s-driver" required></select>
                    <label>P2 Runner Up</label><select id="p2" class="s-driver" required></select>
                    <label>P3 Third</label><select id="p3" class="s-driver" required></select>
                    <hr style="border-color:#333; margin: 20px 0;">
                    <label>P11 (Just Missed Points)</label><select id="p11" class="s-driver" required></select>
                    <label>P12</label><select id="p12" class="s-driver" required></select>
                    <hr style="border-color:#333; margin: 20px 0;">
                    <label>P19</label><select id="p19" class="s-driver" required></select>
                    <label>P20 Last Place</label><select id="p20" class="s-driver" required></select>
                </div>

                <div>
                    <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px;">Constructors & Bonus</h3>
                    <label>1st Team</label><select id="c1" class="s-team" required></select>
                    <label>2nd Team</label><select id="c2" class="s-team" required></select>
                    <label>5th Team</label><select id="c5" class="s-team" required></select>
                    <label>6th Team</label><select id="c6" class="s-team" required></select>
                    <label>10th Team</label><select id="c10" class="s-team" required></select>

                    <h3 style="margin-top: 30px; border-bottom: 1px solid #444; padding-bottom: 10px;">Wildcards</h3>
                    <label style="color:var(--red)">Race: Biggest Loser</label>
                    <select id="wl" class="s-wildcard" required></select>

                    <div id="sprint-box" class="hidden" style="border:1px solid var(--red); padding:15px; margin-top:20px; border-radius:4px; background: rgba(225, 6, 0, 0.05);">
                        <h4 style="margin:0 0 10px; color:var(--red); text-transform: uppercase;">‚ö° Sprint Weekend Bonus</h4>
                        <label>Sprint: Biggest Gainer</label><select id="sg" class="s-wildcard"></select>
                        <label>Sprint: Biggest Loser</label><select id="sl" class="s-wildcard"></select>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn" id="sub-btn">üîí LOCK IN STRATEGY</button>
        </form>
    </div>

    <div id="live" class="tab">
        <h2>Live Predictions</h2>
        <p style="color: #888; font-size: 0.9rem;">Strategies locked for this weekend:</p>
        <div id="live-list">Loading...</div>
        
        <div id="admin-panel" class="admin-box">
            <h3>‚ö†Ô∏è STEWARDS CONTROL</h3>
            <p>Calculate scores and reset grid.</p>
            <button onclick="finalize()" style="background:var(--red); color:white; padding:12px 24px; cursor:pointer; border: none; font-weight: bold; border-radius: 4px;">Finalize Race Weekend</button>
            <p id="adm-stat" style="margin-top: 10px; font-weight: bold;"></p>
        </div>
    </div>

    <div id="standings" class="tab">
        <h2>2026 Season Standings</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 10%;">Pos</th>
                    <th>Player</th>
                    <th style="width: 20%;">Points</th>
                </tr>
            </thead>
            <tbody id="leaderboard">
                <tr><td colspan="3" style="text-align:center; color: #888;">Loading data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="calendar" class="tab">
        <h2>2026 Schedule (IST)</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 10%;">Round</th>
                    <th>Grand Prix & Session Times</th>
                </tr>
            </thead>
            <tbody id="cal-body">
                <tr><td colspan="2" style="text-align:center; color: #888;">Loading calendar...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="grid" class="tab">
        <h2>2026 Official Grid</h2>
        <p style="color: #888;">Complete driver line-up and constructors for the 2026 FIA Formula One World Championship.</p>
        <div id="grid-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            </div>
    </div>

    <div id="rules" class="tab">
        <h2>üìú Official League Regulations</h2>
        <div class="rules-list">
            <h3>‚è∞ 1. The Deadline</h3>
            <ul>
                <li>Predictions are <strong>strictly locked</strong> the exact minute that <strong>Practice 1 (P1)</strong> begins on Friday (or Sprint Qualifying on Sprint weekends).</li>
            </ul>
            <h3>üèéÔ∏è 2. Driver Scoring (P1, P2, P3, P11, P12, P19, P20)</h3>
            <ul>
                <li><strong>Exact Match Bonus:</strong> +2 Points.</li>
                <li><strong>Miss Penalty:</strong> -1 Point for every position your prediction is away from the actual result.</li>
            </ul>
            <h3>üí• 3. The DNF Rule</h3>
            <ul>
                <li>If a driver retires, crashes, or fails to finish (DNF), they are automatically scored as finishing in <strong>P20</strong>.</li>
            </ul>
            <h3>üõ†Ô∏è 4. Constructor Scoring (1st, 2nd, 5th, 6th, 10th)</h3>
            <ul>
                <li>Constructor ranks are based on the combined finishing positions of their two cars in that specific race.</li>
            </ul>
            <h3>üÉè 5. Wildcards</h3>
            <ul>
                <li><strong>Biggest Race Loser:</strong> +5 Points for guessing the driver who drops the most positions from grid to finish.</li>
            </ul>
        </div>
    </div>

    <div id="archive" class="tab">
        <h2>üèÜ 2025 Final Standings</h2>
        <div class="form-grid">
            <div>
                <h3 style="color: var(--red);">Drivers' Championship</h3>
                <table>
                    <thead><tr><th>Pos</th><th>Driver</th><th>Pts</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td>Lando Norris</td><td>423</td></tr>
                        <tr><td>2</td><td>Max Verstappen</td><td>421</td></tr>
                        <tr><td>3</td><td>Oscar Piastri</td><td>410</td></tr>
                        <tr><td>4</td><td>George Russell</td><td>319</td></tr>
                        <tr><td>5</td><td>Charles Leclerc</td><td>242</td></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <h3 style="color: var(--red);">Constructors' Championship</h3>
                <table>
                    <thead><tr><th>Pos</th><th>Team</th><th>Pts</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td>McLaren</td><td>833</td></tr>
                        <tr><td>2</td><td>Mercedes</td><td>469</td></tr>
                        <tr><td>3</td><td>Red Bull Racing</td><td>451</td></tr>
                        <tr><td>4</td><td>Ferrari</td><td>398</td></tr>
                        <tr><td>5</td><td>Williams</td><td>137</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div id="auth" class="modal">
    <div class="modal-box">
        <h2>Paddock Entry</h2>
        <input type="text" id="u-name" placeholder="Driver Name">
        <input type="password" id="u-pass" placeholder="Password">
        <button onclick="login()" class="btn">Enter Garage</button>
        <button onclick="reg()" class="btn" style="background:#444; margin-top: 10px;">Register New Driver</button>
    </div>
</div>

<script>
    const drivers = ["Max Verstappen", "Lando Norris", "Oscar Piastri", "Lewis Hamilton", "Charles Leclerc", "George Russell", "Carlos Sainz", "Alex Albon", "Liam Lawson", "Yuki Tsunoda", "Kimi Antonelli", "Jack Doohan", "Gabriel Bortoleto", "Isack Hadjar", "Franco Colapinto", "Oliver Bearman", "Esteban Ocon", "Pierre Gasly", "Lance Stroll", "Fernando Alonso"].sort();
    const teams = ["Red Bull Racing", "Mercedes", "Ferrari", "McLaren", "Aston Martin", "Alpine", "Williams", "RB", "Haas", "Audi"].sort();
    let user = JSON.parse(localStorage.getItem('f1_user'));
    let raceLock = null;

    document.addEventListener('DOMContentLoaded', () => {
        fillDrops();
        if(!user) {
            document.getElementById('auth').style.display='flex';
        } else {
            document.getElementById('auth').style.display='none';
            start();
        }
    });

    function start() {
        checkAdm();
        loadRace();
        loadBoard();
        buildGridTab(); // Build the new Grid page immediately
        setupSmartDrops();
    }

    function fillDrops() {
        const d = '<option value="">Select...</option>' + drivers.map(x=>`<option value="${x}">${x}</option>`).join('');
        const t = '<option value="">Select...</option>' + teams.map(x=>`<option value="${x}">${x}</option>`).join('');
        document.querySelectorAll('.s-driver, .s-wildcard').forEach(s => s.innerHTML = d);
        document.querySelectorAll('.s-team').forEach(s => s.innerHTML = t);
    }

    function setupSmartDrops() {
        const ds = document.querySelectorAll('.s-driver');
        const ts = document.querySelectorAll('.s-team');
        function update(group) {
            const picked = Array.from(group).map(s => s.value).filter(v => v);
            group.forEach(s => {
                const current = s.value;
                Array.from(s.options).forEach(o => {
                    o.disabled = (o.value && picked.includes(o.value) && o.value !== current) ? true : false;
                });
            });
        }
        ds.forEach(s => s.addEventListener('change', () => update(ds)));
        ts.forEach(s => s.addEventListener('change', () => update(ts)));
    }

    // --- UPDATED: PROFESSIONAL PREDICT HEADER ---
    async function loadRace() {
        try {
            const r = await fetch('/api/next-race').then(res=>res.json());
            
            // Populate the new broadcast header
            document.getElementById('r-round').innerText = `Round ${r.round} of 24`;
            document.getElementById('r-header').innerText = `${r.circuit}, ${r.country}`;
            document.getElementById('r-record').innerHTML = `‚è±Ô∏è <b>Lap Record:</b> ${r.record || 'No record available'}`;
            
            raceLock = new Date(r.date);
            
            const sp = document.getElementById('sprint-box');
            if (r.hasSprint) {
                sp.classList.remove('hidden');
                document.getElementById('sg').required = true;
                document.getElementById('sl').required = true;
            } else {
                sp.classList.add('hidden');
                document.getElementById('sg').required = false;
                document.getElementById('sl').required = false;
            }
            
            if (new Date() > raceLock) {
                document.getElementById('p-form').style.display = 'none';
                document.getElementById('locked-msg').style.display = 'block';
            }
        } catch (e) {
            console.log("API Error", e);
        }
    }

    async function tab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        if(t==='live') loadLive();
        if(t==='standings') loadBoard();
        if(t==='calendar') loadCalendar();
    }

    // --- NEW: THE 2026 GRID PAGE ---
    function buildGridTab() {
        const teamsData = [
            { team: "Ferrari", color: "#E80020", drivers: [{name: "Charles Leclerc", num: 16}, {name: "Lewis Hamilton", num: 44}] },
            { team: "McLaren", color: "#FF8000", drivers: [{name: "Lando Norris", num: 4}, {name: "Oscar Piastri", num: 81}] },
            { team: "Red Bull Racing", color: "#3671C6", drivers: [{name: "Max Verstappen", num: 1}, {name: "Yuki Tsunoda", num: 22}] },
            { team: "Mercedes", color: "#27F4D2", drivers: [{name: "George Russell", num: 63}, {name: "Kimi Antonelli", num: 12}] },
            { team: "Aston Martin", color: "#229971", drivers: [{name: "Fernando Alonso", num: 14}, {name: "Lance Stroll", num: 18}] },
            { team: "Williams", color: "#64C4FF", drivers: [{name: "Carlos Sainz", num: 55}, {name: "Alex Albon", num: 23}] },
            { team: "Alpine", color: "#FF87BC", drivers: [{name: "Pierre Gasly", num: 10}, {name: "Jack Doohan", num: 7}] },
            { team: "Racing Bulls", color: "#6692FF", drivers: [{name: "Liam Lawson", num: 30}, {name: "Isack Hadjar", num: 17}] },
            { team: "Haas", color: "#FFFFFF", drivers: [{name: "Esteban Ocon", num: 31}, {name: "Oliver Bearman", num: 87}] },
            { team: "Audi (Sauber)", color: "#00FF00", drivers: [{name: "Gabriel Bortoleto", num: 5}, {name: "Franco Colapinto", num: 43}] }
        ];

        const container = document.getElementById('grid-container');
        container.innerHTML = teamsData.map(t => `
            <div style="background: var(--card); border-left: 6px solid ${t.color}; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                <h3 style="margin: 0 0 20px 0; font-size: 1.4rem; text-transform: uppercase;">${t.team}</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="background: #1a1a1f; padding: 12px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; font-size: 1.1rem;">${t.drivers[0].name}</span>
                        <span style="background: ${t.color}; color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 900;">${t.drivers[0].num}</span>
                    </div>
                    <div style="background: #1a1a1f; padding: 12px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; font-size: 1.1rem;">${t.drivers[1].name}</span>
                        <span style="background: ${t.color}; color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 900;">${t.drivers[1].num}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function loadLive() {
        const d = await fetch('/api/predictions').then(r=>r.json());
        const list = document.getElementById('live-list');
        if (d.length === 0) {
            list.innerHTML = "<p>No predictions submitted yet for this race.</p>";
        } else {
            list.innerHTML = d.map(x=>`
                <div style="background:#2a2a2f; padding:20px; margin-bottom:15px; border-left:4px solid var(--red); border-radius:4px;">
                    <h3 style="margin:0 0 15px 0; color:var(--red); text-transform:uppercase; font-size: 1.3rem;">üèéÔ∏è ${x.user_name}</h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                        <div style="background:#1a1a1f; padding: 15px; border-radius: 4px;">
                            <strong style="color:#aaa; display:block; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:8px;">DRIVERS</strong>
                            <div style="line-height:1.6; font-size:0.95rem;">
                                <b>P1:</b> ${x.p1} | <b>P2:</b> ${x.p2} | <b>P3:</b> ${x.p3}<br>
                                <b>P11:</b> ${x.p11} | <b>P12:</b> ${x.p12}<br>
                                <b>P19:</b> ${x.p19} | <b>P20:</b> ${x.p20}
                            </div>
                        </div>
                        <div style="background:#1a1a1f; padding: 15px; border-radius: 4px;">
                            <strong style="color:#aaa; display:block; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:8px;">TEAMS</strong>
                            <div style="line-height:1.6; font-size:0.95rem;">
                                <b>1st:</b> ${x.c1} | <b>2nd:</b> ${x.c2}<br>
                                <b>5th:</b> ${x.c5} | <b>6th:</b> ${x.c6}<br>
                                <b>10th:</b> ${x.c10}
                            </div>
                        </div>
                        <div style="background:#1a1a1f; padding: 15px; border-radius: 4px;">
                            <strong style="color:#aaa; display:block; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:8px;">WILDCARDS</strong>
                            <div style="line-height:1.6; font-size:0.95rem;">
                                <b>Race Loser:</b> <span style="color:var(--red)">${x.w_race_loser}</span>
                                ${x.w_sprint_gainer ? `<br><b>Sprint Gainer:</b> <span style="color:#00e160">${x.w_sprint_gainer}</span><br><b>Sprint Loser:</b> <span style="color:var(--red)">${x.w_sprint_loser}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    async function loadBoard() {
        const d = await fetch('/api/season-leaderboard').then(r=>r.json());
        const board = document.getElementById('leaderboard');
        if (d.length === 0) {
            board.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No players registered yet.</td></tr>';
        } else {
            board.innerHTML = d.map((x,i)=>`<tr><td>${i+1}</td><td>${x.name}</td><td><b style="font-size:1.1rem">${x.total_score}</b></td></tr>`).join('');
        }
    }

    async function loadCalendar() {
        const d = await fetch('/api/calendar').then(r=>r.json());
        const body = document.getElementById('cal-body');
        body.innerHTML = d.map(x => {
            const formatTime = (isoString) => {
                if(!isoString) return 'TBC';
                return new Date(isoString).toLocaleString('en-IN', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            };
            let sessionHTML = x.hasSprint ? `
                <div class="session-grid">
                    <div><strong>FP1:</strong> ${formatTime(x.sessions?.fp1)}</div>
                    <div><strong>SQ:</strong> ${formatTime(x.sessions?.sprintQuali)}</div>
                    <div><strong>Sprint:</strong> ${formatTime(x.sessions?.sprint)}</div>
                    <div><strong>Quali:</strong> ${formatTime(x.sessions?.quali)}</div>
                    <div style="grid-column: 1 / -1; margin-top: 5px; color: white;">
                        <strong style="color:var(--red)">RACE:</strong> ${formatTime(x.sessions?.race)}
                    </div>
                </div>
            ` : `
                <div class="session-grid">
                    <div><strong>FP1:</strong> ${formatTime(x.sessions?.fp1)}</div>
                    <div><strong>FP2:</strong> ${formatTime(x.sessions?.fp2)}</div>
                    <div><strong>FP3:</strong> ${formatTime(x.sessions?.fp3)}</div>
                    <div><strong>Quali:</strong> ${formatTime(x.sessions?.quali)}</div>
                    <div style="grid-column: 1 / -1; margin-top: 5px; color: white;">
                        <strong style="color:var(--red)">RACE:</strong> ${formatTime(x.sessions?.race)}
                    </div>
                </div>
            `;
            return `
                <tr>
                    <td style="vertical-align: top; font-size: 1.2rem; font-weight: bold;">${x.round}</td>
                    <td>
                        <strong style="font-size:1.2rem; display:inline-block; margin-bottom: 5px;">${x.name}</strong> 
                        ${x.hasSprint ? '<span class="sprint-badge">Sprint Weekend</span>' : ''}
                        ${sessionHTML}
                    </td>
                </tr>
            `;
        }).join('');
    }

    document.getElementById('p-form').addEventListener('submit', async(e)=>{
        e.preventDefault();
        const body = {
            user_name: user.name, password: user.password,
            p1:val('p1'), p2:val('p2'), p3:val('p3'), p11:val('p11'), p12:val('p12'), p19:val('p19'), p20:val('p20'),
            c1:val('c1'), c2:val('c2'), c5:val('c5'), c6:val('c6'), c10:val('c10'),
            w_race_loser:val('wl'), w_sprint_gainer: document.getElementById('sg').value, w_sprint_loser: document.getElementById('sl').value
        };
        const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if(res.ok) alert('‚úÖ Strategy Locked!'); 
        else {
            const err = await res.json();
            alert('Error: ' + (err.message || 'Locked or Failed'));
        }
    });
    function val(id) { return document.getElementById(id).value; }

    async function finalize() {
        if(!confirm('‚ö†Ô∏è Are you sure? This ends the race weekend.')) return;
        document.getElementById('adm-stat').innerText = 'Processing scores...';
        const res = await fetch('/api/finalize', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_name:user.name, password:user.password}) });
        const d = await res.json();
        if(res.ok) {
            document.getElementById('adm-stat').innerText = '‚úÖ Success!';
            setTimeout(() => location.reload(), 2000);
        } else {
            document.getElementById('adm-stat').innerText = '‚ùå Error: ' + d.message;
        }
    }

    async function login() {
        const name=document.getElementById('u-name').value, password=document.getElementById('u-pass').value;
        const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, password}) });
        if(res.ok) { localStorage.setItem('f1_user', JSON.stringify({name, password})); location.reload(); }
        else alert('Invalid Credentials');
    }
    async function reg() {
        const name=document.getElementById('u-name').value, password=document.getElementById('u-pass').value;
        const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, password}) });
        if(res.ok) alert('Registered! Please Login.');
        else alert('Username taken.');
    }
    function logout() { localStorage.clear(); location.reload(); }
    function checkAdm() { if(user && user.name === 'admin') document.getElementById('admin-panel').style.display = 'block'; }
</script>
</body>
</html>