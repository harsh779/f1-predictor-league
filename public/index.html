<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Predictor 2026</title>
    <style>
        body { font-family: sans-serif; background: #1f1f1f; color: white; padding: 20px; }
        .tab-content { display: none; }
        .active { display: block; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        input { display: block; margin: 10px 0; padding: 10px; width: 100%; max-width: 300px; }
        button { padding: 10px 20px; cursor: pointer; background: #e10600; color: white; border: none; font-weight: bold; }
        .admin-box { border: 2px solid red; padding: 20px; margin-top: 50px; background: #000; }
        table { border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; }
    </style>
</head>
<body>

    <nav>
        <button onclick="showTab('predict')">Predict</button>
        <button onclick="showTab('live')">Live Race</button>
        <button onclick="showTab('standings')">Standings</button>
        <button onclick="logout()">Logout</button>
    </nav>
    <hr>

    <div id="predict" class="tab-content active">
        <h2>Lock in your Strategy</h2>
        <form id="prediction-form">
            <input type="text" id="p1" placeholder="P1 Winner" required>
            <input type="text" id="p2" placeholder="P2" required>
            <input type="text" id="p3" placeholder="P3" required>
            
            <input type="text" id="p11" placeholder="P11" required>
            <input type="text" id="p12" placeholder="P12" required>
            
            <input type="text" id="p19" placeholder="P19" required>
            <input type="text" id="p20" placeholder="P20" required>
            
            <h3>Constructors</h3>
            <input type="text" id="c1" placeholder="Rank 1 Team" required>
            <input type="text" id="c2" placeholder="Rank 2 Team" required>
            <input type="text" id="c5" placeholder="Rank 5 Team" required>
            <input type="text" id="c6" placeholder="Rank 6 Team" required>
            <input type="text" id="c10" placeholder="Rank 10 Team" required>
            <h3>Wildcard</h3>
            <input type="text" id="wl" placeholder="Biggest Race Loser" required>
            <button type="submit">Submit Prediction</button>
        </form>
    </div>

    <div id="live" class="tab-content">
        <h2>Live Paddock Status</h2>
        <div id="predictions-list"></div>

        <div id="admin-controls" style="display: none;" class="admin-box">
            <h3 style="color: red;">STEWARDS ONLY: RACE CONTROL</h3>
            <p>Pressing this will process scores and reset the grid.</p>
            <button id="finalize-btn">Finalize Race Weekend</button>
            <p id="admin-status"></p>
        </div>
    </div>

    <div id="standings" class="tab-content">
        <h2>Season Standings</h2>
        <table width="100%">
            <thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>

    <div id="auth-modal" class="modal" style="display: none;">
        <div style="background: #333; padding: 40px; border-radius: 10px;">
            <h2>Enter the Paddock</h2>
            <input type="text" id="auth-name" placeholder="Name">
            <input type="password" id="auth-pass" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="register()">Register</button>
        </div>
    </div>

    <script>
        let currentUser = JSON.parse(localStorage.getItem('f1_user'));

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentUser) {
                document.getElementById('auth-modal').style.display = 'flex';
            } else {
                checkAdmin();
                loadLeaderboard();
            }
        });

        function checkAdmin() {
            const adminPanel = document.getElementById('admin-controls');
            if (currentUser && currentUser.name === 'admin') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'live') loadLivePredictions();
            if (tabId === 'standings') loadLeaderboard();
        }

        async function login() {
            const name = document.getElementById('auth-name').value;
            const password = document.getElementById('auth-pass').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, password })
            });
            const data = await res.json();
            if (data.success) {
                localStorage.setItem('f1_user', JSON.stringify({ name, password }));
                location.reload();
            } else {
                alert("Login failed!");
            }
        }

        async function register() {
            const name = document.getElementById('auth-name').value;
            const password = document.getElementById('auth-pass').value;
            const res = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, password })
            });
            const data = await res.json();
            alert(data.message);
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                user_name: currentUser.name,
                password: currentUser.password,
                p1: document.getElementById('p1').value,
                p2: document.getElementById('p2').value,
                p3: document.getElementById('p3').value,
                p11: document.getElementById('p11').value,
                p12: document.getElementById('p12').value,
                p19: document.getElementById('p19').value,
                p20: document.getElementById('p20').value,
                c1: document.getElementById('c1').value,
                c2: document.getElementById('c2').value,
                c5: document.getElementById('c5').value,
                c6: document.getElementById('c6').value,
                c10: document.getElementById('c10').value,
                w_race_loser: document.getElementById('wl').value
            };

            const res = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) alert("Strategy Locked!");
        });

        async function loadLivePredictions() {
            const res = await fetch('/api/predictions');
            const data = await res.json();
            document.getElementById('predictions-list').innerHTML = data.map(p => `
                <div style="background: #333; margin: 10px; padding: 10px; border-radius: 5px;">
                    <h3 style="margin-top:0;">${p.user_name}</h3>
                    <p style="margin-bottom:0;">P1: ${p.p1} | C1: ${p.c1}</p>
                </div>
            `).join('');
        }

        async function loadLeaderboard() {
            const res = await fetch('/api/season-leaderboard');
            const data = await res.json();
            document.getElementById('leaderboard-body').innerHTML = data.map((d, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${d.name}</td>
                    <td>${d.total_score}</td>
                </tr>
            `).join('');
        }

        document.getElementById('finalize-btn').addEventListener('click', async () => {
            if (!confirm("Are you sure? This resets the game for the next race!")) return;
            const status = document.getElementById('admin-status');
            status.innerText = "Processing scoring...";
            
            const res = await fetch('/api/finalize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_name: currentUser.name, password: currentUser.password })
            });
            const data = await res.json();
            status.innerText = data.success ? "✅ Success!" : "❌ Error: " + data.message;
            if (data.success) setTimeout(() => location.reload(), 2000);
        });
    </script>
</body>
</html>