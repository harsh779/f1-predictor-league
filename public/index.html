<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 2026 League</title>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --red: #e10600; --bg: #15151e; --card: #1f1f23; --text: #fff; }
        body { margin:0; font-family:'Titillium Web',sans-serif; background:var(--bg); color:var(--text); }
        header { background:var(--red); padding:15px; display:flex; justify-content:space-between; align-items:center; }
        nav button { background:none; border:none; color:white; font-weight:bold; cursor:pointer; font-size:1rem; margin-left:10px; }
        main { padding:20px; max-width:900px; margin:0 auto; }
        .tab { display:none; } .active { display:block; }
        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
        select, input { width:100%; padding:10px; margin:5px 0 15px; background:#2a2a2f; border:1px solid #444; color:white; border-radius:4px; }
        label { font-size:0.9rem; color:#aaa; font-weight:bold; display:block; text-transform:uppercase; }
        .btn { background:var(--red); color:white; border:none; padding:15px; width:100%; font-weight:bold; cursor:pointer; border-radius:4px; margin-top:20px; }
        .admin-box { margin-top:40px; border:2px solid var(--red); padding:20px; background:rgba(225,6,0,0.1); border-radius:8px; display:none; }
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:999; }
        .modal-box { background:#222; padding:30px; border-radius:8px; width:90%; max-width:400px; text-align:center; border:1px solid #444; }
        .hidden { display:none; }
        /* Disabled option style */
        option:disabled { color: #555; background: #1a1a1a; }
    </style>
</head>
<body>

<header>
    <h1>üèÅ F1 2026</h1>
    <nav>
        <button onclick="tab('predict')">Predict</button>
        <button onclick="tab('live')">Live</button>
        <button onclick="tab('standings')">Standings</button>
        <button onclick="logout()">Exit</button>
    </nav>
</header>

<main>
    <div id="predict" class="tab active">
        <h2>Next: <span id="r-name" style="color:var(--red)">Loading...</span></h2>
        <div id="locked-msg" style="display:none; background:var(--red); padding:10px; text-align:center;">üö´ RACE LOCKED</div>
        
        <form id="p-form">
            <div class="form-grid">
                <div>
                    <h3>Drivers</h3>
                    <label>P1 Winner</label><select id="p1" class="s-driver" required></select>
                    <label>P2 Runner Up</label><select id="p2" class="s-driver" required></select>
                    <label>P3 Third</label><select id="p3" class="s-driver" required></select>
                    <hr style="border-color:#333">
                    <label>P11 (Missed Points)</label><select id="p11" class="s-driver" required></select>
                    <label>P12</label><select id="p12" class="s-driver" required></select>
                    <hr style="border-color:#333">
                    <label>P19</label><select id="p19" class="s-driver" required></select>
                    <label>P20 Last</label><select id="p20" class="s-driver" required></select>
                </div>

                <div>
                    <h3>Constructors</h3>
                    <label>1st Team</label><select id="c1" class="s-team" required></select>
                    <label>2nd Team</label><select id="c2" class="s-team" required></select>
                    <label>5th Team</label><select id="c5" class="s-team" required></select>
                    <label>6th Team</label><select id="c6" class="s-team" required></select>
                    <label>10th Team</label><select id="c10" class="s-team" required></select>

                    <h3>Wildcards</h3>
                    <label style="color:var(--red)">Race: Biggest Loser</label>
                    <select id="wl" class="s-wildcard" required></select>

                    <div id="sprint-box" class="hidden" style="border:1px solid var(--red); padding:10px; margin-top:10px; border-radius:4px;">
                        <h4 style="margin:0 0 10px; color:var(--red)">‚ö° SPRINT WEEKEND</h4>
                        <label>Sprint Gainer</label><select id="sg" class="s-wildcard"></select>
                        <label>Sprint Loser</label><select id="sl" class="s-wildcard"></select>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn" id="sub-btn">LOCK STRATEGY</button>
        </form>
    </div>

    <div id="live" class="tab">
        <h2>Live Predictions</h2>
        <div id="live-list"></div>
        <div id="admin-panel" class="admin-box">
            <h3>‚ö†Ô∏è STEWARDS CONTROL</h3>
            <button onclick="finalize()" style="background:var(--red); color:white; padding:10px; cursor:pointer;">Finalize Weekend</button>
            <p id="adm-stat"></p>
        </div>
    </div>

    <div id="standings" class="tab">
        <h2>Championship</h2>
        <table style="width:100%; border-collapse:collapse;">
            <thead><tr style="background:#333; color:var(--red);"><th style="padding:10px; text-align:left;">Pos</th><th>Driver</th><th>Points</th></tr></thead>
            <tbody id="leaderboard"></tbody>
        </table>
    </div>
</main>

<div id="auth" class="modal" style="display:flex;">
    <div class="modal-box">
        <h2>Login</h2>
        <input type="text" id="u-name" placeholder="Name">
        <input type="password" id="u-pass" placeholder="Password">
        <button onclick="login()" class="btn">Enter</button>
        <button onclick="reg()" class="btn" style="background:#444;">Register</button>
    </div>
</div>

<script>
    // DATA
    const drivers = ["Max Verstappen", "Lando Norris", "Oscar Piastri", "Lewis Hamilton", "Charles Leclerc", "George Russell", "Carlos Sainz", "Alex Albon", "Liam Lawson", "Yuki Tsunoda", "Kimi Antonelli", "Jack Doohan", "Gabriel Bortoleto", "Isack Hadjar", "Franco Colapinto", "Oliver Bearman", "Esteban Ocon", "Pierre Gasly", "Lance Stroll", "Fernando Alonso"].sort();
    const teams = ["Red Bull Racing", "Mercedes", "Ferrari", "McLaren", "Aston Martin", "Alpine", "Williams", "RB", "Haas", "Audi"].sort();
    let user = JSON.parse(localStorage.getItem('f1_user'));
    let raceLock = null;

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        fillDrops();
        if(user) { document.getElementById('auth').style.display='none'; start(); }
    });

    function start() {
        checkAdm();
        loadRace();
        loadBoard();
        setupSmartDrops(); // Enable anti-repetition logic
    }

    // 1. DROPDOWNS & SMART LOGIC
    function fillDrops() {
        const d = '<option value="">Select...</option>' + drivers.map(x=>`<option value="${x}">${x}</option>`).join('');
        const t = '<option value="">Select...</option>' + teams.map(x=>`<option value="${x}">${x}</option>`).join('');
        document.querySelectorAll('.s-driver, .s-wildcard').forEach(s => s.innerHTML = d);
        document.querySelectorAll('.s-team').forEach(s => s.innerHTML = t);
    }

    function setupSmartDrops() {
        const ds = document.querySelectorAll('.s-driver'); // Only race positions
        const ts = document.querySelectorAll('.s-team');

        function update(group) {
            const picked = Array.from(group).map(s => s.value).filter(v => v);
            group.forEach(s => {
                Array.from(s.options).forEach(o => {
                    if (o.value && picked.includes(o.value) && o.value !== s.value) o.disabled = true;
                    else o.disabled = false;
                });
            });
        }
        ds.forEach(s => s.addEventListener('change', () => update(ds)));
        ts.forEach(s => s.addEventListener('change', () => update(ts)));
    }

    // 2. RACE & SPRINT LOGIC
    async function loadRace() {
        const r = await fetch('/api/next-race').then(res=>res.json());
        document.getElementById('r-name').innerText = r.name;
        raceLock = new Date(r.date);
        
        // Sprint Toggle
        const sp = document.getElementById('sprint-box');
        if (r.hasSprint) {
            sp.classList.remove('hidden');
            document.getElementById('sg').required = true;
            document.getElementById('sl').required = true;
        } else {
            sp.classList.add('hidden');
            document.getElementById('sg').required = false;
            document.getElementById('sl').required = false;
        }
        
        // Lock Check
        if (new Date() > raceLock) {
            document.getElementById('p-form').style.display = 'none';
            document.getElementById('locked-msg').style.display = 'block';
        }
    }

    // 3. AUTH & ADMIN
    async function login() {
        const name=document.getElementById('u-name').value, password=document.getElementById('u-pass').value;
        const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, password}) });
        if(res.ok) { localStorage.setItem('f1_user', JSON.stringify({name, password})); location.reload(); }
        else alert('Fail');
    }
    async function reg() {
        const name=document.getElementById('u-name').value, password=document.getElementById('u-pass').value;
        await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, password}) });
        alert('Registered');
    }
    function logout() { localStorage.clear(); location.reload(); }
    
    function checkAdm() {
        if(user && user.name === 'admin') document.getElementById('admin-panel').style.display = 'block';
    }

    // 4. SUBMIT & DATA
    document.getElementById('p-form').addEventListener('submit', async(e)=>{
        e.preventDefault();
        const body = {
            user_name: user.name, password: user.password,
            p1:val('p1'), p2:val('p2'), p3:val('p3'), p11:val('p11'), p12:val('p12'), p19:val('p19'), p20:val('p20'),
            c1:val('c1'), c2:val('c2'), c5:val('c5'), c6:val('c6'), c10:val('c10'),
            w_race_loser:val('wl'), 
            w_sprint_gainer: document.getElementById('sg').value,
            w_sprint_loser: document.getElementById('sl').value
        };
        const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if(res.ok) alert('Locked!'); else alert('Error or Locked');
    });
    function val(id) { return document.getElementById(id).value; }

    async function tab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        if(t==='live') {
            const d = await fetch('/api/predictions').then(r=>r.json());
            document.getElementById('live-list').innerHTML = d.map(x=>`<div style="background:#333; padding:10px; margin:5px; border-left:3px solid var(--red)"><b>${x.user_name}</b> | P1: ${x.p1}</div>`).join('');
        }
    }
    async function loadBoard() {
        const d = await fetch('/api/season-leaderboard').then(r=>r.json());
        document.getElementById('leaderboard').innerHTML = d.map((x,i)=>`<tr><td style="padding:10px; border-bottom:1px solid #444">${i+1}</td><td style="border-bottom:1px solid #444">${x.name}</td><td style="border-bottom:1px solid #444">${x.total_score}</td></tr>`).join('');
    }

    async function finalize() {
        if(!confirm('Finalize?')) return;
        document.getElementById('adm-stat').innerText = 'Processing...';
        const res = await fetch('/api/finalize', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_name:user.name, password:user.password}) });
        if(res.ok) location.reload(); else alert('Error');
    }
</script>
</body>
</html>